# ADR 0002: Embed Templates at Build Time

## Status

Accepted

## Context

`@rindrics/initrepo` uses EJS templates to generate project files. Initially, templates were loaded from the filesystem at runtime:

```typescript
const TEMPLATES_DIR = path.join(__dirname, '../templates');
const template = await fs.readFile(path.join(TEMPLATES_DIR, templatePath), 'utf-8');
```

This approach had several issues:

1. **Bun vs Node.js incompatibility**: The code used `import.meta.dir` (Bun-specific) to resolve template paths. When running the bundled CLI with Node.js, this API is undefined, causing `path.join()` to fail with `ERR_INVALID_ARG_TYPE`.

2. **Distribution complexity**: Templates had to be copied alongside the bundled JavaScript (`cp -r src/templates dist/`), requiring:
   - Additional build steps
   - Correct `files` configuration in `package.json` for npm publishing
   - Careful handling of relative paths between the bundle and templates

3. **Runtime file system dependency**: The CLI required read access to template files at runtime, adding a potential failure point.

## Alternatives Considered

### 1. Runtime file loading (original approach)

Templates as separate `.ejs` files, loaded via `fs.readFile()` at runtime.

- ✅ Simple to understand
- ❌ Requires correct path resolution across Bun/Node.js
- ❌ Templates must be distributed alongside the bundle
- ❌ Runtime filesystem dependency

### 2. Inline templates in source code

Templates as template literals directly in TypeScript source.

```typescript
const PACKAGE_JSON_TEMPLATE = `{
  "name": "<%= name %>",
  ...
}`;
```

- ✅ Single-file distribution
- ✅ No build step for templates
- ❌ Poor editing experience (no syntax highlighting for EJS/YAML)
- ❌ Difficult to review changes in PRs
- ❌ Escaping issues with backticks and `${}`

### 3. Build-time embedding (chosen)

Templates managed as `.ejs` files, embedded into a TypeScript module at build time.

- ✅ Single-file distribution
- ✅ Best editing experience (syntax highlighting, linting)
- ✅ Clear diffs in PRs for template changes
- ✅ No runtime filesystem dependency
- ⚠️ Requires build step (`bun scripts/embed-templates.ts`)

## Decision

Embed all EJS templates as string literals in the JavaScript bundle at build time (Alternative 3).

This is a **hybrid approach**: templates are authored as `.ejs` files for developer experience, but converted to an embedded object at build time for distribution simplicity.

### Implementation

1. **Build script** (`scripts/embed-templates.ts`):
   - Scans `src/templates/` for `.ejs` files
   - Generates `src/generators/embedded-templates.ts` with all templates as a `Record<string, string>`

2. **Template loading** (`src/generators/project.ts`):
   - Changed from async file reading to synchronous lookup in the embedded map
   - Removed filesystem and path resolution logic

```typescript
// Before (runtime loading)
export async function loadTemplate(templatePath: string, data: Record<string, unknown>): Promise<string> {
  const template = await fs.readFile(path.join(TEMPLATES_DIR, templatePath), 'utf-8');
  return ejs.render(template, data);
}

// After (embedded templates)
export function loadTemplate(templatePath: string, data: Record<string, unknown>): string {
  const template = EMBEDDED_TEMPLATES[templatePath];
  if (!template) throw new TemplateError(`Template not found: "${templatePath}"`, templatePath);
  return ejs.render(template, data);
}
```

3. **Build process**:
   ```json
   "build": "bun scripts/embed-templates.ts && bun build src/cli.ts --outdir dist --target node"
   ```

### Generated File

The `embedded-templates.ts` file is auto-generated and should not be edited manually. It is gitignored and regenerated on each build.

## Consequences

### Positive

- **Single-file distribution**: The CLI is now a self-contained JavaScript file with no external dependencies on template files
- **Cross-runtime compatibility**: Works with both Bun and Node.js without conditional path resolution
- **Simpler npm publishing**: No need to configure `files` to include template directories
- **Faster execution**: No filesystem I/O for template loading
- **Synchronous API**: `loadTemplate()` is now synchronous, simplifying call sites

### Negative

- **Larger bundle size**: Templates are embedded as strings in the bundle (~20KB increase)
- **Build step required**: Templates must be regenerated when changed (`bun scripts/embed-templates.ts`)
- **Generated file**: `embedded-templates.ts` is auto-generated, which may cause confusion if edited directly

### Mitigations

- The generated file includes a clear header: `// Auto-generated by scripts/embed-templates.ts - Do not edit manually`
- `embedded-templates.ts` is added to `.gitignore` to prevent accidental commits
- The build script runs automatically as part of `pnpm build`
- Bundle size increase is negligible for a CLI tool
